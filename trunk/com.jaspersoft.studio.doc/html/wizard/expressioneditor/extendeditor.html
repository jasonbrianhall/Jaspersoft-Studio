<html><head><META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>Expression Editor: how to extend it and contribute your own functions</title><meta content="DocBook XSL Stylesheets V1.78.0" name="generator"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="N40003"></a>Expression Editor: how to extend it and contribute your own functions</h2></div></div><hr></div>
	
	<div class="section"><div class="titlepage"></div>
		<p>In this section, we will cover some of the internal workings of the Functions Library. We will explain how it is implemented and how a developer can extend it in order to contribute his own functions in the environment.</p>
		<p>
			The best way to understand how the Function Library works and how to extend it is to access the source code and start looking at it. The source code is available from the public SVN repository 
			<a class="ulink" href="http://anonsvn:anonsvn@code.jaspersoft.com/svn/repos/jasperreportsexpressions/" target="_top">at this link</a>.
			From this URL you can download two projects:
			</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: opencircle; "><li class="listitem" style="list-style-type: circle">net.sf.jasperreports.expressions: contains the basic stuff like the dedicated JasperReports Extensions Registry (and Factory), the annotation classes and an utility class to work with them;</li><li class="listitem" style="list-style-type: circle">net.sf.jasperreports.expressions.functions: contains the built-in functions that we provide categorized in different classes, an utility class to manipulate them, plus the jasperreports_extension.properties file;</li></ul></div><p>
			So JasperReports Extensions mechanism and Java Annotations are two key concepts behind the Functions Library:
			</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: opencircle; "><li class="listitem" style="list-style-type: circle">net.sf.jasperreports.expressions.ExprFunctionsRegistry: this extension registry is used to collect generic classes that contain the implementations of the methods that will be proposed as functions in the expression editor;</li><li class="listitem" style="list-style-type: circle">net.sf.jasperreports.expressions.ExprFunctionsRegistryFactory: the extension registry factory class as specified in the jasperreports_extension.properties file. The registry_id chosen is expression.functions.
					<div class="figure"><a name="N40029"></a><p class="title"><b>Figure&nbsp;1.&nbsp;jasperreports_extension.properties file</b></p><div class="figure-contents">
						
						<div class="screenshot">
							<div class="mediaobject"><img src="5.png" alt="jasperreports_extension.properties file"></div>
						</div>
					</div></div><br class="figure-break">
				</li><li class="listitem" style="list-style-type: circle">net.sf.jasperreports.expressions.annotations.JRExprFunction: annotation used to mark a function;</li><li class="listitem" style="list-style-type: circle">net.sf.jasperreports.expressions.annotations.JRExprFunctionCategories: annotation used to list the set of categories to which a function can belong to;</li><li class="listitem" style="list-style-type: circle">net.sf.jasperreports.expressions.annotations.JRExprFunctionParameter: annotation used to specify a parameter associated to a function;</li><li class="listitem" style="list-style-type: circle">net.sf.jasperreports.expressions.annotations.JRExprFunctionParameters: annotation used to list the set of parameters that a function can use;</li></ul></div><p>
			Besides these classes, those ones that contain the "functions implementation" are inside the project net.sf.jasperreports.expressions.functions and are listed below:
			</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: opencircle; "><li class="listitem" style="list-style-type: circle">net.sf.jasperreports.expressions.functions.DateTimeFunctions: contains the functions belonging to the category Built-in Functions &gt; Date and Time</li><li class="listitem" style="list-style-type: circle">net.sf.jasperreports.expressions.functions.LogicalFunctions: contains the functions belonging to the category Built-in Functions &gt; Logical</li><li class="listitem" style="list-style-type: circle">net.sf.jasperreports.expressions.functions.MathFunctions: contains the functions belonging to the category Built-in Functions &gt; Numeric / Mathematical</li><li class="listitem" style="list-style-type: circle">net.sf.jasperreports.expressions.functions.TextFunctions: contains the functions belonging to the category Built-in Functions &gt; Text</li></ul></div><p>
			As you may have noticed this list is exactly the same present as property net.sf.jasperreports.extension.expression.functions.classes.stdlib.
		</p>
		<p>
			At this point, you may have figure out that in order to contribute your own functions it's a matter of writing your Java class(es) and list them into .properties file.
			First of all let's give a look at how a function should be written looking into an existing one, then as a further step we will create a new function that will be contributed to the expression editor.
		</p>
		<p>
			For our analysis we will use the WEEKDAY function that as the description states "Returns the day of the week for a given date. Date object can be a String, long value (millis) or Date instance itself."
			This is how it appears in the expression editor with some valid values already set:
		</p>
		<div class="figure"><a name="N40061"></a><p class="title"><b>Figure&nbsp;2.&nbsp;WEEKDAY function in the expression editor</b></p><div class="figure-contents">
			
			<div class="screenshot">
				<div class="mediaobject"><img src="6.png" alt="WEEKDAY function in the expression editor"></div>
			</div>
		</div></div><br class="figure-break">
		<p>
			Please note that the only mandatory parameter is the Date object that is highlighted in the red box (there is a star in top right corner of the description label). 
			The second parameter is optional and it specifies if Sunday should be considered as first day of the week (default is not).
		</p>
		<p>
			Let's now give a look at the code snippet subtending this function.
		</p>
		<div class="figure"><a name="N4007A"></a><p class="title"><b>Figure&nbsp;3.&nbsp;Code of the WEEKDAY function</b></p><div class="figure-contents">
			
			<div class="screenshot">
				<div class="mediaobject"><img src="7.png" alt="Code of the WEEKDAY function"></div>
			</div>
		</div></div><br class="figure-break">
		<p>
			As you can see there are two methods WEEKDAY: the first one has the only mandatory parameter, while the second one exhibits also the optional Boolean parameter.
			The rule of thumb, when you create a new function, is that you should enrich with annotations the base method that has mandatory parameters with all the necessary information.
			Looking at the example above, you see that this includes the use of:
			</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: opencircle; "><li class="listitem" style="list-style-type: circle">JRExprFunction: basic information on the function, like its name and description;</li><li class="listitem" style="list-style-type: circle">JRExprFunctionCategories: the category to wich the function belongs to;</li><li class="listitem" style="list-style-type: circle">JRExprFunctionParameters: the list of JRExprFunctionParameter (name and description) elements representing all the parameters, both mandatory and optional;</li></ul></div><p>
			This quick overview of a standard library function should be enough to allow us to do right now a step forward. Let's then implement and contribute a new function that will be available in the expression editor.
		</p> 
		<p>
			We will now proceed creating a new Java Project where it will be possible to start coding our new function(s).
			Your work environment will look similar to the following one:
		</p>
		<div class="figure"><a name="N400A0"></a><p class="title"><b>Figure&nbsp;4.&nbsp;Work environment example</b></p><div class="figure-contents">
			
			<div class="screenshot">
				<div class="mediaobject"><img src="8.png" width="800" alt="Work environment example"></div>
			</div>
		</div></div><br class="figure-break">
		<p>
			Summarizing these are the steps that should be performed:
			</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: opencircle; "><li class="listitem" style="list-style-type: circle">Create a Java Project "CustomExpressionFunctions"</li><li class="listitem" style="list-style-type: circle">Add via "Java Build Path" the libraries jasperreports-expressions-x.y.z.jar and jasperreports-exprfunctions-x.y.z.jar. They can be found in the dist folder of the related projects.</li><li class="listitem" style="list-style-type: circle">
					Create a Java Class net.sf.jasperreports.expressions.functions.tests.CustomFunctions that contains the code for the function REPEATMESSAGE
					<div class="figure"><a name="N400C1"></a><p class="title"><b>Figure&nbsp;5.&nbsp;REPEATMESSAGE code</b></p><div class="figure-contents">
						
						<div class="screenshot">
							<div class="mediaobject"><img src="extra1.png" alt="REPEATMESSAGE code"></div>
						</div>
					</div></div><br class="figure-break">
				</li><li class="listitem" style="list-style-type: circle">
					Create a jasperreports_extension.properties file that contains the mandatory information:
					<div class="figure"><a name="N400D7"></a><p class="title"><b>Figure&nbsp;6.&nbsp;jasperreports_extension.properties for REPEATMESSAGE</b></p><div class="figure-contents">
						
						<div class="screenshot">
							<div class="mediaobject"><img src="extra2.png" alt="jasperreports_extension.properties for REPEATMESSAGE"></div>
						</div>
					</div></div><br class="figure-break">
				</li><li class="listitem" style="list-style-type: circle">Package all the stuff into a jar file that can then be attached to our report project.</li></ul></div><p>
			Moving to our Jaspersoft Studio runtime environment, the first thing to do is to add the previously exported jar as library. This can of course be done via "Java Build Path" section.
			</p><div class="figure"><a name="N400EF"></a><p class="title"><b>Figure&nbsp;7.&nbsp;Add the .jar that contains the new function</b></p><div class="figure-contents">
				
				<div class="screenshot">
					<div class="mediaobject"><img src="9.png" alt="Add the .jar that contains the new function"></div>
				</div>
			</div></div><p><br class="figure-break">
			Once this is done, next time you will open the expression editor you will be able to use the newly contributed function:
			</p><div class="figure"><a name="N40102"></a><p class="title"><b>Figure&nbsp;8.&nbsp;The new function is now into the expression editor</b></p><div class="figure-contents">
				
				<div class="screenshot">
					<div class="mediaobject"><img src="10.png" alt="The new function is now into the expression editor"></div>
				</div>
			</div></div><p><br class="figure-break">
			As you can see you can create a simple report that allows you to see your brand-new function in action. This is a very simple example of how it will looks like:
			</p><div class="figure"><a name="N40115"></a><p class="title"><b>Figure&nbsp;9.&nbsp;Test of the new function</b></p><div class="figure-contents">
				
				<div class="screenshot">
					<div class="mediaobject"><img src="11.png" alt="Test of the new function"></div>
				</div>
			</div></div><p><br class="figure-break">
		</p>
	</div>
</div></body></html>