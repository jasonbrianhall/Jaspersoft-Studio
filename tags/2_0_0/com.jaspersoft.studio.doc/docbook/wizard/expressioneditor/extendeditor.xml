<?xml version="1.0" encoding="UTF-8"?>
<section version="5.0" xsi:schemaLocation="http://docbook.org/ns/docbook http://www.docbook.org/xml/5.0/xsd/docbook.xsd http://www.w3.org/1999/xlink http://www.docbook.org/xml/5.0/xsd/xlink.xsd"
	xml:base="../" xmlns="http://docbook.org/ns/docbook" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xlink="http://www.w3.org/1999/xlink"
	xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:ns="http://docbook.org/ns/docbook">
	<title>Expression Editor: how to extend it and contribute your own functions</title>
	<section>
		<para>In this section, we will cover some of the internal workings of the Functions Library. We will explain how it is implemented and how a developer can extend it in order to contribute his own functions in the environment.</para>
		<para>
			The best way to understand how the Function Library works and how to extend it is to access the source code and start looking at it. The source code is available from the public SVN repository 
			<ulink url="http://anonsvn:anonsvn@code.jaspersoft.com/svn/repos/jasperreportsexpressions/">at this link</ulink>.
			From this URL you can download two projects:
			<itemizedlist mark='opencircle'>
			<listitem>net.sf.jasperreports.expressions: contains the basic stuff like the dedicated JasperReports Extensions Registry (and Factory), the annotation classes and an utility class to work with them;</listitem>
			<listitem>net.sf.jasperreports.expressions.functions: contains the built-in functions that we provide categorized in different classes, an utility class to manipulate them, plus the jasperreports_extension.properties file;</listitem>
			</itemizedlist>
			So JasperReports Extensions mechanism and Java Annotations are two key concepts behind the Functions Library:
			<itemizedlist mark='opencircle'>
				<listitem>net.sf.jasperreports.expressions.ExprFunctionsRegistry: this extension registry is used to collect generic classes that contain the implementations of the methods that will be proposed as functions in the expression editor;</listitem>
				<listitem>net.sf.jasperreports.expressions.ExprFunctionsRegistryFactory: the extension registry factory class as specified in the jasperreports_extension.properties file. The registry_id chosen is expression.functions.
					<figure>
						<title>jasperreports_extension.properties file</title>
						<screenshot>
							<mediaobject>
								<imageobject>
									<imagedata fileref="5.png" format="PNG"/>
								</imageobject>
							</mediaobject>
						</screenshot>
					</figure>
				</listitem>
				<listitem>net.sf.jasperreports.expressions.annotations.JRExprFunction: annotation used to mark a function;</listitem>
				<listitem>net.sf.jasperreports.expressions.annotations.JRExprFunctionCategories: annotation used to list the set of categories to which a function can belong to;</listitem>
				<listitem>net.sf.jasperreports.expressions.annotations.JRExprFunctionParameter: annotation used to specify a parameter associated to a function;</listitem>
				<listitem>net.sf.jasperreports.expressions.annotations.JRExprFunctionParameters: annotation used to list the set of parameters that a function can use;</listitem>
			</itemizedlist>
			Besides these classes, those ones that contain the "functions implementation" are inside the project net.sf.jasperreports.expressions.functions and are listed below:
			<itemizedlist mark='opencircle'>
				<listitem>net.sf.jasperreports.expressions.functions.DateTimeFunctions: contains the functions belonging to the category Built-in Functions > Date and Time</listitem>
				<listitem>net.sf.jasperreports.expressions.functions.LogicalFunctions: contains the functions belonging to the category Built-in Functions > Logical</listitem>
				<listitem>net.sf.jasperreports.expressions.functions.MathFunctions: contains the functions belonging to the category Built-in Functions > Numeric / Mathematical</listitem>
				<listitem>net.sf.jasperreports.expressions.functions.TextFunctions: contains the functions belonging to the category Built-in Functions > Text</listitem>
			</itemizedlist>
			As you may have noticed this list is exactly the same present as property net.sf.jasperreports.extension.expression.functions.classes.stdlib.
		</para>
		<para>
			At this point, you may have figure out that in order to contribute your own functions it's a matter of writing your Java class(es) and list them into .properties file.
			First of all let's give a look at how a function should be written looking into an existing one, then as a further step we will create a new function that will be contributed to the expression editor.
		</para>
		<para>
			For our analysis we will use the WEEKDAY function that as the description states "Returns the day of the week for a given date. Date object can be a String, long value (millis) or Date instance itself."
			This is how it appears in the expression editor with some valid values already set:
		</para>
		<figure>
			<title>WEEKDAY function in the expression editor</title>
			<screenshot>
				<mediaobject>
					<imageobject>
						<imagedata fileref="6.png" format="PNG" />
					</imageobject>
				</mediaobject>
			</screenshot>
		</figure>
		<para>
			Please note that the only mandatory parameter is the Date object that is highlighted in the red box (there is a star in top right corner of the description label). 
			The second parameter is optional and it specifies if Sunday should be considered as first day of the week (default is not).
		</para>
		<para>
			Let's now give a look at the code snippet subtending this function.
		</para>
		<figure>
			<title>Code of the WEEKDAY function</title>
			<screenshot>
				<mediaobject>
					<imageobject>
						<imagedata fileref="7.png" format="PNG" />
					</imageobject>
				</mediaobject>
			</screenshot>
		</figure>
		<para>
			As you can see there are two methods WEEKDAY: the first one has the only mandatory parameter, while the second one exhibits also the optional Boolean parameter.
			The rule of thumb, when you create a new function, is that you should enrich with annotations the base method that has mandatory parameters with all the necessary information.
			Looking at the example above, you see that this includes the use of:
			<itemizedlist mark='opencircle'>
				<listitem>JRExprFunction: basic information on the function, like its name and description;</listitem>
				<listitem>JRExprFunctionCategories: the category to wich the function belongs to;</listitem>
				<listitem>JRExprFunctionParameters: the list of JRExprFunctionParameter (name and description) elements representing all the parameters, both mandatory and optional;</listitem>
			</itemizedlist>
			This quick overview of a standard library function should be enough to allow us to do right now a step forward. Let's then implement and contribute a new function that will be available in the expression editor.
		</para> 
		<para>
			We will now proceed creating a new Java Project where it will be possible to start coding our new function(s).
			Your work environment will look similar to the following one:
		</para>
		<figure>
			<title>Work environment example</title>
			<screenshot>
				<mediaobject>
					<imageobject>
						<imagedata fileref="8.png" format="PNG" />
					</imageobject>
				</mediaobject>
			</screenshot>
		</figure>
		<para>
			Summarizing these are the steps that should be performed:
			<itemizedlist mark='opencircle'>
				<listitem>Create a Java Project "CustomExpressionFunctions"</listitem>
				<listitem>Add via "Java Build Path" the libraries jasperreports-expressions-x.y.z.jar and jasperreports-exprfunctions-x.y.z.jar. They can be found in the dist folder of the related projects.</listitem>
				<listitem>
					Create a Java Class net.sf.jasperreports.expressions.functions.tests.CustomFunctions that contains the code for the function REPEATMESSAGE
					<figure>
						<title>REPEATMESSAGE code</title>
						<screenshot>
							<mediaobject>
								<imageobject>
									<imagedata fileref="extra1.png" format="PNG" />
								</imageobject>
							</mediaobject>
						</screenshot>
					</figure>
				</listitem>
				<listitem>
					Create a jasperreports_extension.properties file that contains the mandatory information:
					<figure>
						<title>jasperreports_extension.properties for REPEATMESSAGE</title>
						<screenshot>
							<mediaobject>
								<imageobject>
									<imagedata fileref="extra2.png" format="PNG" />
								</imageobject>
							</mediaobject>
						</screenshot>
					</figure>
				</listitem>
				<listitem>Package all the stuff into a jar file that can then be attached to our report project.</listitem>
			</itemizedlist>
			Moving to our Jaspersoft Studio runtime environment, the first thing to do is to add the previously exported jar as library. This can of course be done via "Java Build Path" section.
			<figure>
				<title>Add the .jar that contains the new function</title>
				<screenshot>
					<mediaobject>
						<imageobject>
							<imagedata fileref="9.png" format="PNG" />
						</imageobject>
					</mediaobject>
				</screenshot>
			</figure>
			Once this is done, next time you will open the expression editor you will be able to use the newly contributed function:
			<figure>
				<title>The new function is now into the expression editor</title>
				<screenshot>
					<mediaobject>
						<imageobject>
							<imagedata fileref="10.png" format="PNG" />
						</imageobject>
					</mediaobject>
				</screenshot>
			</figure>
			As you can see you can create a simple report that allows you to see your brand-new function in action. This is a very simple example of how it will looks like:
			<figure>
				<title>Test of the new function</title>
				<screenshot>
					<mediaobject>
						<imageobject>
							<imagedata fileref="11.png" format="PNG" />
						</imageobject>
					</mediaobject>
				</screenshot>
			</figure>
		</para>
	</section>
</section>